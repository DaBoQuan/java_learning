<%@ page contentType="text/html; charset=UTF-8"%>
<%@ page import="com.eweaver.base.BaseJdbcDao"%>
<%@ page import="java.util.*"%>
<%@ page import="java.text.*"%>
<%@ page import="com.eweaver.base.util.*" %>
<%@ page import="com.eweaver.base.*" %>
<%@ page import="com.eweaver.base.BaseContext" %>
<%@ page import="com.eweaver.base.label.service.LabelService" %>
<%@ page import="com.eweaver.base.security.service.acegi.EweaverUser" %>
<%@ page import="com.eweaver.humres.base.model.Humres" %>
<%@ page import="com.eweaver.humres.base.service.HumresService" %>
<%@ page import="com.eweaver.base.setitem.service.SetitemService"%>
<%@ page import="com.eweaver.base.util.DateHelper"%>

<%
	System.out.println("**************************************************");
	BaseJdbcDao baseJdbc = (BaseJdbcDao) BaseContext.getBean("baseJdbcDao");
	String cktype=StringHelper.null2String(request.getParameter("cktype"));//出口类型
	String feetype=StringHelper.null2String(request.getParameter("feetype"));//费用类型
	String supcode=StringHelper.null2String(request.getParameter("supcode"));//供应商简码
	String zgcurr=StringHelper.null2String(request.getParameter("zgcurr"));//暂估币种
	String area=StringHelper.null2String(request.getParameter("area"));//厂区别
	String comtype=StringHelper.null2String(request.getParameter("comtype"));//公司别
	String jbman=StringHelper.null2String(request.getParameter("jbman"));//经办人
	String taxcode=StringHelper.null2String(request.getParameter("taxcode"));//税码
	String bgdegin=StringHelper.null2String(request.getParameter("bgdegin"));//报关起
	String bgend=StringHelper.null2String(request.getParameter("bgend"));//报关止
	String expnum="";
	String cabtype1="";
	String delsql="delete from uf_tr_exdzdetailf";
	baseJdbc.update(delsql);
	System.out.println(cktype);
	System.out.println(feetype);
	String sql="";
	int no=0;
	if(cktype.equals("40285a90497a8f7801497d7b4cbd0032"))//出口
	{
		String sqlwhere="";
		String sqlwhere1="";
		expnum=StringHelper.null2String(request.getParameter("expno"));
		cabtype1=StringHelper.null2String(request.getParameter("cabtype"));
		//sqlwhere=sqlwhere+" and f.payto='"+supcode+"' and f.currency='"+zgcurr+"' and b.factory='"+area+"'";
		sqlwhere=sqlwhere+"  and b.factory='"+area+"'";
		if(!supcode.equals(""))
		{
			sqlwhere=sqlwhere+" and f.payto='"+supcode+"'";
		}
		if(!comtype.equals(""))
		{
			sqlwhere=sqlwhere+" and b.comname='"+comtype+"'";
		}
		if(!taxcode.equals(""))
		{
			sqlwhere=sqlwhere+" and f.taxcode=(select tc.taxcode from uf_oa_taxcode tc where tc.requestid='"+taxcode+"' and 0=(select fb.isdelete from formbase fb where id=tc.requestid))";
		}
		if(!bgdegin.equals(""))
		{
			sqlwhere=sqlwhere+" and c.closedate>='"+bgdegin+"'";
		}
		if(!bgend.equals(""))
		{
			sqlwhere=sqlwhere+" and c.closedate<='"+bgend+"'";
		}
		if(!zgcurr.equals(""))
		{
			sqlwhere=sqlwhere+" and f.currency='"+zgcurr+"'";
		}
		if(!jbman.equals(""))
		{
			sqlwhere=sqlwhere+" and instr(c.bginfopsn,'"+jbman+"')>0";
		}
		if(!feetype.equals(""))//产品大类
		{
			sqlwhere=sqlwhere+" and c.goodsgroup='"+feetype+"'";
		}
		if(!expnum.equals(""))//出口编号
		{
			sqlwhere=sqlwhere+" and c.expno like '%"+expnum+"%'";
		}
		if(!cabtype1.equals(""))//柜型
		{
			if(cabtype1.equals("40285a905291f42701531b095962097f"))//TANK
			{
				//sqlwhere=sqlwhere+" and a.cabtype like '%TK%' ";
			}
			else//GP
			{
				//sqlwhere=sqlwhere+" and a.cabtype like '%GP%' ";
			}
		}



			sql="select f.payto,c.requestid as expnoid ,c.expno,c.deliveryno,c.closedate,c.notifydate,c.departure,c.destport,'' cabtype,null as cabnum,'' nw,null as gw,f.feetype,f.currency as covercurrency,a.notaxsum notaxvalue,a.notaxfee,d.costctr,f.taxcode,c.salepzno,h.hadcreate,'' fdje,a.suminsured,a.factor,a.currency,a.rate as hl,a.notaxinsure,a.lowestinsure,c.bginfopsn from uf_tr_feewater a inner join uf_tr_feetentative b on a.requestid=b.requestid inner join uf_tr_expboxmain c on b.noticeno=c.requestid inner join (select requestid,wm_concat(distinct(costctr)) costctr from uf_tr_shipment group by requestid)  d on c.requestid=d.requestid inner join uf_tr_feedivvy f on f.requestid=b.requestid and f.feetype=(select fy.requestid from uf_tr_fymcwhd  fy where fy.costname='水险保险费' and fy.factype='"+area+"' and fy.importandexport='40285a90497a8f7801497d7b4cbd0032') and f.currency=a.covercurrency left join uf_tr_exfeedtdivvy g on g.zgid=f.id and 0=(select isdelete from requestbase re3 where re3.id=g.requestid) left join uf_tr_exfeetentdtmain h on h.requestid=g.requestid  and (h.isvalid is null or h.isvalid='40288098276fc2120127704884290210') left join formbase re1 on re1.id=a.requestid left join requestbase re2 on re2.id=c.requestid where 0=re1.isdelete and 0=re2.isdelete and (b.isvalid is null or b.isvalid='40288098276fc2120127704884290210') and (c.isvalid is null or c.isvalid='40288098276fc2120127704884290210')";
			sql=sql+sqlwhere+" group by  f.payto,c.requestid,c.expno,c.deliveryno,c.closedate,c.notifydate,f.feetype,f.currency,a.notaxsum,a.notaxfee,d.costctr,f.taxcode,c.salepzno,h.hadcreate,a.suminsured,a.factor,a.currency,a.rate,a.notaxinsure,a.lowestinsure,c.bginfopsn,c.departure,c.destport";
			sql=sql+" union all (";
			//物流园
			sql=sql+"select f.payto,c.requestid as expnoid ,c.expno,c.deliveryno,c.closedate,c.notifydate,c.departure,c.destport,'' cabtype,null as cabnum,'' nw,null as gw,f.feetype,f.currency as covercurrency,a.notaxsum notaxvalue,a.notaxfee,d.costctr,f.taxcode,c.salepzno,h.hadcreate,'' fdje,a.suminsured,a.factor,a.currency,a.rate as hl,a.notaxinsure,a.lowestinsure,c.bginfopsn from uf_tr_feelogis a inner join uf_tr_feetentative b on a.requestid=b.requestid inner join uf_tr_expboxmain c on b.noticeno=c.requestid inner join (select requestid,wm_concat(distinct(costctr)) costctr from uf_tr_shipment group by requestid)  d on c.requestid=d.requestid inner join uf_tr_feedivvy f on f.requestid=b.requestid and f.feetype=(select fy.requestid from uf_tr_fymcwhd  fy where fy.costname='物流园保险费' and fy.factype='"+area+"' and fy.importandexport='40285a90497a8f7801497d7b4cbd0032') and f.currency=a.covercurrency left join uf_tr_exfeedtdivvy g on g.zgid=f.id and 0=(select isdelete from requestbase re3 where re3.id=g.requestid) left join uf_tr_exfeetentdtmain h on h.requestid=g.requestid  and (h.isvalid is null or h.isvalid='40288098276fc2120127704884290210') left join formbase re1 on re1.id=a.requestid left join requestbase re2 on re2.id=c.requestid where 0=re1.isdelete and 0=re2.isdelete and (b.isvalid is null or b.isvalid='40288098276fc2120127704884290210') and (c.isvalid is null or c.isvalid='40288098276fc2120127704884290210')";
			sql=sql+sqlwhere;
			sql=sql+" group by f.payto,c.requestid,c.expno,c.deliveryno,c.closedate,c.notifydate,f.feetype,f.currency ,a.notaxsum,a.notaxfee,d.costctr,f.taxcode,c.salepzno,h.hadcreate,a.suminsured,a.factor,a.currency,a.rate,a.notaxinsure,a.lowestinsure,c.bginfopsn,c.departure,c.destport)";
		//}
		System.out.println(sql);
		List list = baseJdbc.executeSqlForList(sql);
		Map map=null;
		if(list.size()>0){
			for(int k=0;k<list.size();k++)
			{
				map = (Map)list.get(k);
				String expno=StringHelper.null2String(map.get("expno"));//出口编号
				String expnoid=StringHelper.null2String(map.get("expnoid"));//出口编号ID
				String deliveryno=StringHelper.null2String(map.get("deliveryno"));//提单号
				String closedate=StringHelper.null2String(map.get("closedate"));//预计结关日期
				String notifydate=StringHelper.null2String(map.get("notifydate"));//报关日期
				String departure=StringHelper.null2String(map.get("departure"));//起运港
				String destport=StringHelper.null2String(map.get("destport"));//目的港
				String cabtype=StringHelper.null2String(map.get("cabtype"));//柜型
				String cabnum=StringHelper.null2String(map.get("cabnum"));//柜数
				String nw=StringHelper.null2String(map.get("nw"));//净重
				String gw=StringHelper.null2String(map.get("gw"));//毛重
				String feetype1=StringHelper.null2String(map.get("feetype"));//费用类型
				String currency=StringHelper.null2String(map.get("currency"));//币种
				String notaxvalue=StringHelper.null2String(map.get("notaxvalue"));//未税金额
				String notaxfee=StringHelper.null2String(map.get("notaxfee"));//未税费率
				if(notaxvalue.equals(""))
				{
					notaxvalue="0";
				}
				if(notaxfee.equals(""))
				{
					notaxfee="0";
				}
				String costctr=StringHelper.null2String(map.get("costctr"));//成本中心
				String taxcode1=StringHelper.null2String(map.get("taxcode"));//税码
				String salepzno=StringHelper.null2String(map.get("salepzno"));//销售凭证号
				String hadcreate=StringHelper.null2String(map.get("hadcreate"));//会计凭证
				String fdje=StringHelper.null2String(map.get("fdje"));//封顶金额
				String suminsured=StringHelper.null2String(map.get("suminsured"));//保额
				String factor=StringHelper.null2String(map.get("factor"));//系数
				String covercurrency=StringHelper.null2String(map.get("covercurrency"));//投保币种
				String hl=StringHelper.null2String(map.get("hl"));//汇率
				String notaxinsure=StringHelper.null2String(map.get("notaxinsure"));//未税保费金额
				String lowestinsure=StringHelper.null2String(map.get("lowestinsure"));//最大保费金额
				String bginfopsn=StringHelper.null2String(map.get("bginfopsn"));
				String payto=StringHelper.null2String(map.get("payto"));
				String taxvalue="";
				String taxfee="";
				no++;
				//40285a8d51e694c20151e70b57100aa4
				String tcodesql="select taxtype,taxrate from uf_oa_taxcode where taxcode='"+taxcode1+"' and 0=(select isdelete from formbase where id=requestid)";
				List list1 = baseJdbc.executeSqlForList(tcodesql);
				Map map1=null;
				String taxtype="";
				String taxrate="0";
				if(list1.size()>0){
					map1 = (Map)list1.get(0);
					taxtype=StringHelper.null2String(map1.get("taxtype"));
					taxrate=StringHelper.null2String(map1.get("taxrate"));
				}
				//价外 未税=含税/1+税率
				//价内 未税=含税*1-税率	
				if(taxtype.equals("40285a9048f924a70148fe66247a0dc9"))//价外税
				{
					Double a=Double.valueOf(notaxvalue)*(100+Double.valueOf(taxrate))/100;
					Double b=Double.valueOf(notaxfee)*(100+Double.valueOf(taxrate))/100;
					DecimalFormat df = new DecimalFormat("#0.00");   
					taxvalue =String.valueOf( df.format(a)); 
					taxfee = String.valueOf(df.format(b)); 
					
				}
				else
				{
					Double c=Double.valueOf(notaxvalue)*100/(100-Double.valueOf(taxrate));
					Double d=Double.valueOf(notaxfee)*100/(100-Double.valueOf(taxrate));
					DecimalFormat df = new DecimalFormat("#0.00");   
					taxvalue =String.valueOf( df.format(c)); 
					taxfee = String.valueOf(df.format(d)); 
				}
				String insql="insert into uf_tr_exdzdetailf (id,requestid,no,exnum,tdnum,yjjgdate,bgdate,gygang,mdgang,cabitype,cabnum,netvalue,roughvalue,feetype,curr,taxamount,notaxamount,taxrate,notaxrate,costcen,taxcode,saleno,kjpzno,jbname,fdje,baoe,xishu,tbcurr,hl,wsbaoe,zdbaoe,exnumid,payto)values((select sys_guid() from dual),'40285a9051d9773c01520b48c28856e2',"+no+",'"+expno+"','"+deliveryno+"','"+closedate+"','"+notifydate+"','"+departure+"','"+destport+"','"+cabtype+"','"+cabnum+"','"+nw+"','"+gw+"','"+feetype1+"','"+currency+"','"+taxvalue+"','"+notaxvalue+"','"+taxfee+"','"+notaxfee+"','"+costctr+"','"+taxcode1+"','"+salepzno+"','"+hadcreate+"','"+bginfopsn+"','"+fdje+"','"+suminsured+"','"+factor+"','"+covercurrency+"','"+hl+"','"+notaxinsure+"','"+lowestinsure+"','"+expnoid+"','"+payto+"')";
				//System.out.println(insql);
				baseJdbc.update(insql);
			}
		}

	}
	
%>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   